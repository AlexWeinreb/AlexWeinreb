<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alexis Weinreb">
<meta name="dcterms.date" content="2023-11-09">

<title>AlexWeinreb - Writing a Notepad++ plugin</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">AlexWeinreb</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/AlexWeinreb" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://genomic.social/@AlexWe" rel="" target=""><i class="bi bi-mastodon" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Writing a Notepad++ plugin</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">programming</div>
                <div class="quarto-category">bioinformatics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Alexis Weinreb </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 9, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>I am in the process of writing a plugin for Notepad++ to perform some biological operations. As I am not familiar with C++ and other compiled languages, I am taking some notes here about the process.</p>
<p>Note, another approach that I haven’t tried but might be of interest to anyone reading this: there is a <a href="https://npppythonscript.sourceforge.net/">PythonScript</a> plugin that may allow to do all of this in a much easier way.</p>
<section id="motivation-notepad-for-dna-sequences" class="level1">
<h1>Motivation: Notepad++ for DNA sequences</h1>
<p>The plugin provides a few functions to work with biological sequences, namely taking the reverse-complement of a DNA string, getting its protein translation, and finding the next ORF. Of course such functions are already available in plenty of specialized software (e.g.&nbsp;<a href="https://jorgensen.biology.utah.edu/wayned/ape/">ApE</a> or <a href="benchling.com">Benchling</a>), so why add it to a unrelated application?</p>
<p>I use dedicated DNA software regularly, but it tends to be quite rigid, accepting only DNA characters, no space, little formatting… which is a good thing, as it makes it safer and avoid typos. But sometimes I need more of a sketchpad, pasting fragments of DNA in different frames, along with bits of translations. Maybe looking at some sequence in different frames. Maybe looking at a BAM file and trying to find a barcode and UMI. In these cases, I’ve found Notepad++ very useful, in particular it has this great feature that, if I select a sequence, it will highlight all identical sequences (more flexible than the search function of ApE or Benchling). But it is slightly annoying to switch between windows whenever I want to check if a string is present in revcomp etc.</p>
</section>
<section id="tooling" class="level1">
<h1>Tooling</h1>
<p>To develop a plugin, the first step is to go to <a href="https://npp-user-manual.org/docs/plugins/#how-to-develop-a-plugin">the corresponding page</a> in the Notepad++ documentation.</p>
<p>There, you will find promises to develop your first plugin in less than 10 minutes, and that “Even your grandmom can do it!”, I believe this is true, assuming your grandmom is familiar with C++ and the Win32 API.</p>
<p>So let’s see how this works. First you need to work in a compiled language, that is able to use existing header files and produce a DLL. If your favorite language doesn’t do that, or if you have no idea what any of this means, I suggest to use with the classic C++.</p>
<p>You will need a development environment for C++, in particular a compiler and Windows header files. The easiest is to look up <a href="https://visualstudio.microsoft.com/downloads/">Microsoft Visual Studio</a>, and download the (free) Community Edition. Careful, the naming is confusing: you don’t want “Visual Studio Code”, which is a different program. From the website, you can only download an installer, and from there you can download the full Community edition (note that it is several GB). In addition, you will want to download the C++ bundle which contains important build tools.</p>
<p>Separately, you can open the <a href="https://npp-user-manual.org/docs/plugins/#how-to-develop-a-plugin">plugin development</a> section of the Notepad++ user manual, and download the <a href="https://github.com/npp-plugins/plugintemplate/releases">plugin template</a> source code.</p>
</section>
<section id="editing-the-plugin-template" class="level1">
<h1>Editing the plugin template</h1>
<p>Once Visual Studio is fully installed, we start open our project. Make a copy of the plugin template with the appropriate name and path. This contains two subdirectories, <code>src</code>, for your source code, and <code>vs.proj</code>, containing information for Visual Studio. In particular, the file <code>vs.proj/NppPluginTemplate.vcxproj</code> can be opened in Visual Studio.</p>
<p>The files to edit are in <code>src</code>. Two files need to be edited:</p>
<ul>
<li><code>PluginDefinition.cpp</code> is where you define your actual plugin functions</li>
<li><code>PluginDefinition.h</code> is where you declare the functions</li>
<li><code>NppPluginDemo.rc</code> declares some general information (e.g.&nbsp;plugin name and version)</li>
</ul>
<p>As far as I can tell, you won’t need to edit any other file in there. I added a <code>README.md</code> and a <code>LICENSE</code> for Github. If you download the <a href="https://github.com/npp-plugins/plugindemo/releases">plugin demo</a> you can see how they added a <code>resource</code> folder and <code>resource.h</code> file.</p>
</section>
<section id="compiling-the-plugin" class="level1">
<h1>Compiling the plugin</h1>
<p>Before going any further, we might want to check our configuration. Download the <a href="https://github.com/npp-plugins/plugindemo/releases">plugin demo</a> and open it in Visual Studio. In the toolbar on top of the screen, you should see a menu such as this one:</p>
<p><img src="resource/compilation_menu.png" class="img-fluid"></p>
<p>The first field is to select the type of compilation: while developing, “Debug” gives you more information about the errors and log messages. When you have a satisfying version of your code, select “Release” to compile an optimized program, that gives less information about what’s happening.</p>
<p>The second menu is the architecture to compile for. It needs to match the version of Notepad++ installed: if you have the 32 bits version, compile “x86”, if you have the 64 bits, compile as “x86”. On a final version, you may want to compile for both architectures and make the binaries available on Github.</p>
<p>Finally, the “Play” symbol starts the compilation. Click it having selected the appropriate parameters. If everything goes well, you will get an error message along the lines of:</p>
<blockquote class="blockquote">
<p>Unable to start ‘C:\path\to\PluginDemo.dll’.</p>
<p>C:\path\to\PluginDemo.dll is not a valid Win32 application.</p>
</blockquote>
<p>Indeed, our plugin is not expected to be a valid standalone application, it’s just a dll that can be loaded by another application (Notepad++).</p>
<p>Open the directory of your plugin, in <code>vs.proj</code> a new subdirectory has been created, containing the newly compiled binary.</p>
<p>All that’s left to do is to <a href="https://npp-user-manual.org/docs/plugins/#install-plugin-manually">install this plugin by copy/pasting it in the appropriate directory</a>. Don’t forget to close Notepad++ before pasting. Then, when you re-open Notepad++, your new plugin should have appeared in the “Plugins” menu.</p>
</section>
<section id="preparing-to-write-a-first-function" class="level1">
<h1>Preparing to write a first function</h1>
<p>Now let’s start to work on a real plugin. As indicated <a href="https://npp-user-manual.org/docs/plugins/#how-to-develop-a-plugin">in the manual</a>, we start by opening <code>PluginDefinition.h</code>. We define the plugin name:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">//-------------------------------------//</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">//-- STEP 1. DEFINE YOUR PLUGIN NAME --//</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">//-------------------------------------//</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Here define your plugin name</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> TCHAR NPP_PLUGIN_NAME<span class="op">[]</span> <span class="op">=</span> TEXT<span class="op">(</span><span class="st">"Biotools for NPP"</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And we define the number of functions, let’s start with just one:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">//-----------------------------------------------//</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">//-- STEP 2. DEFINE YOUR PLUGIN COMMAND NUMBER --//</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">//-----------------------------------------------//</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Here define the number of your plugin commands</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> nbFunc <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A bit below that, we need to indicate the name of the functions:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Your plugin command functions</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> revcomp<span class="op">();</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we can switch to the file <code>PluginDefinition.cpp</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">//--------------------------------------------//</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//-- STEP 3. CUSTOMIZE YOUR PLUGIN COMMANDS --//</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//--------------------------------------------//</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// with function :</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// setCommand(int index,                      // zero based number to indicate the order of command</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">//            TCHAR *commandName,             // the command name that you want to see in plugin menu</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">//            PFUNCPLUGINCMD functionPointer, // the symbol of function (function pointer) associated with this command. The body should be defined below. See Step 4.</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">//            ShortcutKey *shortcut,          // optional. Define a shortcut to trigger this command</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//            bool check0nInit                // optional. Make this menu item be checked visually</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">//            );</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    setCommand<span class="op">(</span><span class="dv">0</span><span class="op">,</span> TEXT<span class="op">(</span><span class="st">"Reverse-Complement"</span><span class="op">),</span> revcomp<span class="op">,</span> NULL<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The first command has an index of <code>0</code>, and will call the function <code>revcomp()</code>. Note that this only compiles if <code>revcomp()</code> has been declared in the header file (<code>PluginDefinition.h</code>), otherwise the compiler won’t know this is a correct function name.</p>
<p>And we arrive at this part, where we can finally start writing our actual functions:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">//----------------------------------------------//</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">//-- STEP 4. DEFINE YOUR ASSOCIATED FUNCTIONS --//</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">//----------------------------------------------//</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="the-notepad-and-scintilla-apis" class="level1">
<h1>The Notepad++ and Scintilla APIs</h1>
<p>Now things get a bit more specific. To interact with Notepad++, you can use the API calls <a href="https://npp-user-manual.org/docs/plugin-communication/">listed here</a>. However, the main editor window is actually not directly controlled by Notepad++, it’s piloted by <a href="https://en.wikipedia.org/wiki/Scintilla_(software)">Scintilla</a>, so you can interact with it using the API calls <a href="https://www.scintilla.org/ScintillaDoc.html">listed there</a>.</p>
<p>Finally, as indicated in <a href="https://npp-user-manual.org/docs/plugin-communication/#notepad-messages">the Notepad++ documentation</a>, these calls have to be made using Window’s <a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-sendmessage"><code>SendMessage</code> API</a>, and will have the form:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>LRESULT SendMessage<span class="op">(</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>in<span class="op">]</span> HWND   hWnd<span class="op">,</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>in<span class="op">]</span> UINT   Msg<span class="op">,</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>in<span class="op">]</span> WPARAM wParam<span class="op">,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>in<span class="op">]</span> LPARAM lParam</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>hWnd</code> is a handle to the Notepad++ or Scintilla program we are sending the message to, <code>Msg</code> is the name of the command to execute (fron the documentations linked above), and <code>wParam</code> and <code>lParam</code> and parameters explained by the documentation.</p>
<p>Let’s make a concrete example. For my function <code>revcomp()</code>, I expect the user to select a text and call the plugin. The plugin needs to get the selected text, do some processing, and replace it with a modified text. So how do we get the selected text? As this is happening inside the editor window, we look at the Scintilla API, and find <a href="https://www.scintilla.org/ScintillaDoc.html#SCI_GETSELTEXT"><code>SCI_GETSELTEXT</code></a>:</p>
<blockquote class="blockquote">
<p>SCI_GETSELTEXT(<unused>, char *text NUL-terminated) → position This copies the currently selected text and a terminating NUL(0) byte to the text buffer. The buffer size should be determined by calling with a NULL pointer for the text argument: 1 + SCI_GETSELTEXT(0, NULL). This allows for rectangular and discontiguous selections as well as simple selections. See Multiple Selection for information on how multiple and rectangular selections and virtual space are copied.</unused></p>
</blockquote>
<p>So, we need to write</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>SendMessage<span class="op">(</span>scintillaHandle<span class="op">,</span> SCI_GETSELTEXT<span class="op">,</span> whatever<span class="op">,</span> ptr<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>whatever</code> will be ignored, and <code>ptr</code> is a pointer to a buffer in which the selected text will be written.</p>
<p>Here we have an additional difficulty: we need to initialize this buffer, and it needs to be long enough. So, as indicated in the doc, we will call this function twice, first using “a NULL pointer for the text argument”, and a second time with an appropriate pre-initialized buffer.</p>
<p>We can thus write this function:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>string<span class="op"> </span>getSelectedText<span class="op">(</span>HWND scintillaHandle<span class="op">)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string<span class="op"> </span>selectedText<span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Determine the buffer size needed for the selected text</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    LPARAM length <span class="op">=</span> <span class="op">::</span>SendMessage<span class="op">(</span>scintillaHandle<span class="op">,</span> SCI_GETSELTEXT<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">(</span>LPARAM<span class="op">)</span><span class="kw">nullptr</span><span class="op">);</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>length <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span><span class="op">*</span> buffer <span class="op">=</span> <span class="kw">new</span> <span class="dt">char</span><span class="op">[</span>length <span class="op">+</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span> <span class="co">// Ensure the buffer is null-terminated</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Retrieve the selected text</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">::</span>SendMessage<span class="op">(</span>scintillaHandle<span class="op">,</span> SCI_GETSELTEXT<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">(</span>LPARAM<span class="op">)</span>buffer<span class="op">);</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        selectedText <span class="op">=</span> buffer<span class="op">;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span><span class="op">[]</span> buffer<span class="op">;</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        selectedText <span class="op">=</span> <span class="st">""</span><span class="op">;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> selectedText<span class="op">;</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Some notes. First, I call <code>::SendMessage()</code> to indicate that this is a function in the global namespace, and it doesn’t get overwritten. This appears to be the accepted good practice in this context.</p>
<p>As the first parameter of <code>SCI_GETSELTEXT</code> (the <code>wParam</code>) is ignored, I use <code>0</code> here.</p>
<p>When determining the buffer size, I can use the <code>nullptr</code> that already exists in C++ to define a NULL pointer. I will cast it <a href="https://stackoverflow.com/questions/2515261/what-are-the-definitions-for-lparam-and-wparam">into an <code>LPARAM</code></a> to make sure the type checker doesn’t complain.</p>
<p>One part that this function doesn’t address is the <code>scintillaHandle</code>. How can I call this function? For this, we must turn to the Notepad++ interface, where we find <a href="https://npp-user-manual.org/docs/plugin-communication/#2028-nppm-getcurrentscintilla"><code>NPPM_GETCURRENTSCINTILLA</code></a>:</p>
<blockquote class="blockquote">
<p>[2028] NPPM_GETCURRENTSCINTILLA</p>
<p>Retrieves the current Scintilla view</p>
<p>Parameters:</p>
<p>wParam [in] int, must be zero. lParam [out]</p>
<pre><code>int * currentEdit, pointer to the buffer receiving the current view. The returned value can be one of the following:

  Value        Meaning
    0          The main view
    1          The second view
   -1          In case of an error</code></pre>
<p>Return value:</p>
<pre><code>Returns always True</code></pre>
</blockquote>
<p>So we got it, we need to call:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="op">::</span>SendMessage<span class="op">(</span>nppData<span class="op">.</span>_nppHandle<span class="op">,</span> NPPM_GETCURRENTSCINTILLA<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">(</span>LPARAM<span class="op">)&amp;</span>which<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Where the <code>nppData._nppHandle</code> is defined by Notepad++ and contain its handle, <code>wParam = 0</code> as indicated by the documentation, and we give a pointer to <code>which</code> to store the Scintilla handle. To check for error, we can initialize <code>which</code> to a meaningless value, and select the handle based on the value of <code>which</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> which <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="op">::</span>SendMessage<span class="op">(</span>nppData<span class="op">.</span>_nppHandle<span class="op">,</span> NPPM_GETCURRENTSCINTILLA<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">(</span>LPARAM<span class="op">)&amp;</span>which<span class="op">);</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>which <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>HWND scintillaHandle <span class="op">=</span> <span class="op">(</span>which <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> nppData<span class="op">.</span>_scintillaMainHandle <span class="op">:</span> nppData<span class="op">.</span>_scintillaSecondHandle<span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>string<span class="op"> </span>selection <span class="op">=</span> getSelectedText<span class="op">(</span>scintillaHandle<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="runtime-debugging" class="level1">
<h1>Runtime debugging</h1>
<p>There are three types of bugs: those that are detected directly by Visual Studio (typically syntax errors), and that appear underlined in red; those that are caught during compilation; and finally bugs that only manifest at runtime.</p>
<p>To help debug this last category, you can output some debugging information (the so-called print-based debugging). One way is to insert the information as text in the editor window (e.g.&nbsp;using <code>SCI_REPLACESEL</code>), or open a dialog box. The more “correct” way is to use debugging messages with <code>OutputDebugString()</code>. The problem now is, we have a dll, so Visual Studio can not directly run our code.</p>
<p>The solution is to first open Notepad++ with the plugin loaded, then in Visual Studio, use the menu Debug&gt;Attach to Process, and attach the running Notepad++. You can now interact with the open Window, and any debugging messages are printed in Visual Studio.</p>
</section>
<section id="additional-remarks" class="level1">
<h1>Additional remarks</h1>
<p>First, as I am not experienced with C++ you should probably not trust me.</p>
<p>When closing Visual Studio, you get offered to save a “.sln” file, you can say yes, it saves the state of the program (e.g.&nbsp;currently open documents).</p>
<p>The best way to figure out how to do something is to look on Github or Sourceforge at other plugins.</p>
<p>To create a new function, you need to edit 4 places, in the header file (number of functions, signature of your new function) and the cpp file (in the menu, and to write the actual function).</p>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>My (badly written) plugin can be found <a href="https://github.com/AlexWeinreb/biotools_npp">on Github</a>. Writing C++ code was an interesting (though confusing) experience, I would need a lot more practice to write anything close to good quality code.</p>
<p>As the plugin has reached a level of functionality that is good enough for my needs, I don’t intend to work more on it; however there could be useful improvements, for example to accept whitespace in the input (and either keep it as-is for the reverse-complement and next ORF, or remove it if inside a codon for translation).</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>